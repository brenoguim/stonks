<!DOCTYPE html>
<html>

<style>
table, td {
  border: 1px solid black;
}
</style>

<head>
<title>Stonks</title>
<meta charset="utf-8" />
</head>

<body>
  <h1>Adicionar arquivo de movimentações</h1>

  <input type="file" name="inputfile" accept=".xlsx	" id="inputfile" multiple/>

<br><br>

<h2>Tabela de vendas e lucro por mês com cálculo de imposto a ser pago</h2>

<table id="TabelaDeVendasGlobal">
<thead>
    <tr>
    <td>Ano/Mes</td>
    <td>Vendas no mês</td>
    <td>Lucro no mês</td>
    <td>Lucro acumulado</td>
    <td>Imposto</td>
    <td>Imposto deduzido de prejuízo</td>
    </tr>
</thead>
</table>

<br><br>
<h2>Carteira</h2>
<br>
Usamos um proxy server para conseguir acessar dados do Yahoo Finance. Para habilitar o proxy <a href="https://cors-anywhere.herokuapp.com/" target="_blank" rel="noopener noreferrer">entre aqui</a> e clique para autorizar.
Vai demorar apenas 2 segundos :)
<br>
Agora que voce fez isso, clique aqui para calcular a rentabilidade:
<br><br>

<input id="clickMe" type="button" value="Baixar dados de mercado e calcular rentabilidade" onclick="calculateProfit();"/>
<table id="TabelaDeCarteira">
<thead>
    <tr>
    <td>Ação</td>
    <td>Quantidade</td>
    <td>Preço médio</td>
    <td>Valor de aquisição</td>
    <td>Valor de mercado</td>
    <td>Rentabilidade</td>
    <td>Lucro/Prejuízo</td>
    </tr>
</thead>
</table>




</body>
</html>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>

<script>
let realBRLocale = Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
});

function asCurrency(value) {
    return realBRLocale.format(value)
}

function getMonth(date) {
    return new Date(date.getFullYear(), date.getMonth()+1, 0);
}

function parseCurrency(value) {
    return parseFloat(value.replace(/,/, '.').replace(/[.](?=.*[.])/g, ""))
}

function arrLast(arr) { return arr[arr.length - 1]; }

function parseDate(date) {
    // Expect DD/MM/YYYY
    var parts = date.split("/")
    return new Date(parseInt(parts[2]),
                    parseInt(parts[1]),
                    parseInt(parts[0]))
}

var original_ops = [];
var wallet = [];
var s_stockPrices = {};

function updateTable(opsPerMonth) {
    var table = document.getElementById("TabelaDeVendasGlobal");
    
    while (table.rows.length > 1) {
        table.deleteRow(-1);
    }

    for (let m = 0; m < opsPerMonth.length; m++) {
        var mo = opsPerMonth[m];
        var r = table.insertRow(-1);
        r.insertCell(-1).innerHTML = mo.date.toLocaleDateString();
        r.insertCell(-1).innerHTML = asCurrency(mo.sold);
        r.insertCell(-1).innerHTML = asCurrency(mo.profit);
        r.insertCell(-1).innerHTML = asCurrency(mo.accProfit);
        r.insertCell(-1).innerHTML = asCurrency(mo.taxOnGain);
        r.insertCell(-1).innerHTML = asCurrency(mo.lossDeducedTaxOnGain);
    }
}

function updateWalletTable() {
    var table = document.getElementById("TabelaDeCarteira");
    
    while (table.rows.length > 1) {
        table.deleteRow(-1);
    }

    for (let i = 0; i < wallet.length; i++) {
        var s = wallet[i];
        var r = table.insertRow(-1);
        r.insertCell(-1).innerHTML = s.ticker;
        r.insertCell(-1).innerHTML = s.ownedStocks;
        r.insertCell(-1).innerHTML = asCurrency(s.avgPrice);
        r.insertCell(-1).innerHTML = asCurrency(s.ownedStocks * s.avgPrice);

        var mktPrice = (s.ticker in s_stockPrices) ? arrLast(s_stockPrices[s.ticker])[1] : 0;
        r.insertCell(-1).innerHTML = mktPrice != 0 ? asCurrency(mktPrice) : "-";
        r.insertCell(-1).innerHTML = mktPrice != 0 ? (100.0 * mktPrice / s.avgPrice - 100) : "-";
        r.insertCell(-1).innerHTML = mktPrice != 0 ? asCurrency(s.ownedStocks * (mktPrice - s.avgPrice)) : "-";
    }
}

function differentMonth(d1, d2) {
    return d1.getMonth() != d2.getMonth() || d1.getFullYear() != d2.getFullYear();
}

function processOps(ops) {
        ops = structuredClone(ops);

        for (let i = 0; i < ops.length; i++) {
            ops[i].date = parseDate(ops[i]["Data do Negócio"]);
            ops[i].ticker = ops[i]["Código de Negociação"];
            ops[i].sell = ops[i]["Tipo de Movimentação"] == "Venda";
            ops[i].numStocks = parseInt(ops[i]["Quantidade"]);
            ops[i].unitPrice = parseCurrency(ops[i]["Preço"]);
        }

        ops.sort(function(e1, e2) {
            return e1.date < e2.date ? -1 : 1;
        });

        // Calculate num stocks + avg buy price
        var numStocks = {};
        var avgPrice = {};
        for (let i = 0; i < ops.length; i++) {
            var o = ops[i];
            if (!(o.ticker in numStocks)) { numStocks[o.ticker] = 0; avgPrice[o.ticker] = 0; }

            if (o.sell) {
                numStocks[o.ticker] -= o.numStocks;
                o.profit = (o.unitPrice -  avgPrice[o.ticker]) * o.numStocks;
            } else {
                var prevMktValue = avgPrice[o.ticker] * numStocks[o.ticker];

                numStocks[o.ticker] += o.numStocks;
                o.ownedStocks = numStocks[o.ticker];

                var newMktValue = prevMktValue + o.numStocks * o.unitPrice;

                avgPrice[o.ticker] = newMktValue / o.ownedStocks;
            }

            o.avgPrice = avgPrice[o.ticker];
        }

        // Separate in operations per month
        var opsPerMonth = [];
        var lastDate = new Date;
        for (let i = 0; i < ops.length; i++) {
            var m = getMonth(ops[i].date);
            if (differentMonth(m, lastDate)) {
                opsPerMonth.push({'date': m, 'ops' : []});
            }
            lastDate = m;
            opsPerMonth[opsPerMonth.length-1].ops.push(ops[i]);
        }

        // Calculate sold amount
        var accProfit = 0;
        for (let m = 0; m < opsPerMonth.length; m++) {
            var mops = opsPerMonth[m].ops;
            var sold = 0;
            var profit = 0;
            for (let i = 0; i < mops.length; i++) {
                var o = mops[i];
                if (o.sell) {
                    sold += o.unitPrice * o.numStocks;
                    profit += o.profit;
                }
            }
            accProfit += profit;
            opsPerMonth[m].sold = sold;
            opsPerMonth[m].profit = profit;

            var taxOnGain = profit > 0 && sold > 20000 ? 0.15*profit : 0;
            opsPerMonth[m].taxOnGain = taxOnGain;
            
            // If made a bit of profit, but I'm on overall losses, deduce the taxes
            //     I would have to pay from overall losses
            if (taxOnGain > 0 && accProfit < 0) {
                var losses = -accProfit;
                if (losses >= taxOnGain) {
                    losses -= taxOnGain;
                    taxOnGain = 0;
                } else {
                    taxOnGain -= losses;
                    losses = 0;
                }
                accProfit = -losses;
            }

            opsPerMonth[m].lossDeducedTaxOnGain = taxOnGain;
            opsPerMonth[m].accProfit = accProfit;
        }
        return opsPerMonth;
}

function calculateWallet(opsPerMonth) {
    var lastOps = {};
    for (let m = 0; m < opsPerMonth.length; m++) {
        var mops = opsPerMonth[m].ops;
        for (let i = 0; i < mops.length; i++) {
            lastOps[mops[i].ticker] = mops[i];
        }            
    }

    var wallet = [];
    for (const [ticker, lastOp] of Object.entries(lastOps)) {
        if (lastOp.ownedStocks > 0) {
            wallet.push({ 'ticker' : ticker, 'ownedStocks' : lastOp.ownedStocks, 'avgPrice' : lastOp.avgPrice });
        }
    }
    return wallet;
}



function readFile(file) {
    var fr = new FileReader();
    fr.onload = function(e) {
        var workbook = XLSX.read(e.target.result, {type: 'binary'});
        var Sheet = workbook.SheetNames[0];
        var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[Sheet]);

        original_ops = original_ops.concat(excelRows);

        var r = processOps(original_ops);
        wallet = calculateWallet(r);
        updateTable(r);
        updateWalletTable();
    };
    fr.readAsBinaryString(file);
}

async function getStockPrices(stock) {
    const cors_url = "https://cors-anywhere.herokuapp.com/";
    const yahoo_url = "https://query1.finance.yahoo.com/v8/finance/chart/"
    const config = "?metrics=low&interval=1d&range=5y";

    let url = cors_url + yahoo_url + stock + ".SA" + config;
    const response = await fetch(url);
    const json = await response.json();

    const timestamps = json.chart.result[0].timestamp;
    const closingValues = json.chart.result[0].indicators.quote[0].close;

    var prices = [];
    for (let i = 0; i < timestamps.length; i++) {
        prices.push([new Date(timestamps[i]*1000), closingValues[i]]);
    }

    s_stockPrices[stock] = prices;
}

function calculateProfit() {
    stockPrice = {};
    for (let i = 0; i < wallet.length; i++) {
        var s = wallet[i];
        getStockPrices(s.ticker).then(updateWalletTable);
    }
}

document.getElementById('inputfile')
    .addEventListener('change', function() {
        original_ops = [];
        for (let i = 0; i < this.files.length; i++) {
            readFile(this.files[i]);
        }
    })
</script>
