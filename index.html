<!DOCTYPE html>
<html>

<style>
table, td {
  border: 1px solid black;
}
</style>

<head>
<title>Stonks</title>
<meta charset="utf-8" />
</head>

<body>
  <h1>Adicionar arquivo de movimentações</h1>

  <input type="file" name="inputfile" accept=".csv" id="inputfile"/>
  
<table id="myTable">

</table>
  
  
</body>
</html>

<script>

let realBRLocale = Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
});

function asCurrency(value) {
    return realBRLocale.format(value)
}


class Movimentacao {
    constructor(numAcoes, preco) {
        this.numAcoes = numAcoes;
        this.preco = preco;
    }
    
    static default() {
        return new Movimentacao(0,0);
    }

    compra() {
        return this.numAcoes >= 0
    }
    
    toString() {
        return "[Mov | numAçoes: " + this.numAcoes + " | preco: " + this.preco + "]";
    }
}

class Estado {
    constructor(numAcoes, precoMedio, lucroAcumulado, impostoAcumulado) {
        this.numAcoes = numAcoes
        this.precoMedio = precoMedio;
        this.lucroAcumulado = lucroAcumulado;
        this.impostoAcumulado = impostoAcumulado
    }
    
    static default() {
        return new Estado(0,0,0,0);
    }
    
    clone() {
        return new Estado(this.numAcoes, this.precoMedio, this.lucroAcumulado, this.impostoAcumulado)
    }
    
    valor() {
        return this.numAcoes * this.precoMedio
    }
    
    toString() {
        return "[Estado | numAçoes: " + this.numAcoes + " | preco médio: " + this.precoMedio + " | lucro acumulado: " + this.lucroAcumulado + " | patrimonio: " + this.valor() + " Imposto acumulado: " + this.impostoAcumulado + "]";
    }
}

function aplicarMovimentacao(estado, mov) {
    var nestado = estado.clone()
    
    var valor = nestado.valor()
    
    nestado.numAcoes += mov.numAcoes
    
    if (mov.compra()) {
        nestado.precoMedio = (valor + mov.numAcoes * mov.preco) / nestado.numAcoes
        nestado.impostoAcumulado += mov.numAcoes * mov.preco * 0.275;
    } else {
        var lucro = -1 * mov.numAcoes * (mov.preco - nestado.precoMedio);
        if (lucro > 0) {
            nestado.impostoAcumulado += lucro * 0.15;
        }
        nestado.lucroAcumulado += lucro
    }
    
    return nestado
}

function parseCurrency(value) {
    return value.replace(/,/, '.').replace(/[.](?=.*[.])/g, "")
}

function CSVToMovimentacao(text) {
    var movimentacoes = {};
    var lines = text.split(/\r?\n|\r|\n/g);
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].length == 0) {
            continue
        }
        
        var items = lines[i].split(/;/g)
        if (!(items[0] in movimentacoes)) {
            movimentacoes[items[0]] = []
        }
        movimentacoes[items[0]].push(new Movimentacao(parseInt(items[1]), parseCurrency(items[2])))
    }
    return movimentacoes;
}

function executarMovimentacoes(states, movimentacoes) {
    for (const [acao, movs] of Object.entries(movimentacoes)) {
        if (!(acao in states)) {
            states[acao] = [[Movimentacao.default(), Estado.default()]]
        }
        for (let i = 0; i < movs.length; i++) {
            var last = states[acao][states[acao].length - 1];
            var mov = movs[i]
            var last_state = last[1]
            var new_state = aplicarMovimentacao(last_state, mov)
            states[acao].push([mov, new_state])
        }
    }    
}

function updateTable(states) {
    var table = document.getElementById("myTable");
    var hdr = table.insertRow(0)
    hdr.insertCell(0).innerHTML = "Ação"
    hdr.insertCell(1).innerHTML = "Operação"
    hdr.insertCell(2).innerHTML = "Número de ações"
    hdr.insertCell(3).innerHTML = "Preço"
    hdr.insertCell(4).innerHTML = "Estado da carteira"
    hdr.insertCell(5).innerHTML = "Acumulado de ações"
    hdr.insertCell(6).innerHTML = "Preço médio"
    hdr.insertCell(7).innerHTML = "Valor patrimonial"
    hdr.insertCell(8).innerHTML = "Lucro acumulado"
    hdr.insertCell(9).innerHTML = "Imposto acumulado"
    
    for (const [acao, mov2states] of Object.entries(states)) {
        var e = Estado.default();
        for (let i = 0; i < mov2states.length; i++) {
            var row = table.insertRow(table.nrows);
            row.insertCell(0).innerHTML = acao;
            var mov = mov2states[i][0];
            row.insertCell(1).innerHTML = mov.compra() ? "Vest" : "Venda"
            row.insertCell(2).innerHTML = mov.numAcoes
            row.insertCell(3).innerHTML = asCurrency(mov.preco)
            var state = mov2states[i][1]
            row.insertCell(4)
            row.insertCell(5).innerHTML = state.numAcoes
            row.insertCell(6).innerHTML = asCurrency(state.precoMedio)
            row.insertCell(7).innerHTML = asCurrency(state.valor())
            row.insertCell(8).innerHTML = asCurrency(state.lucroAcumulado)
            row.insertCell(9).innerHTML = asCurrency(state.impostoAcumulado)
        }
    }
}

document.getElementById('inputfile')
    .addEventListener('change', function() {
    
        var fr=new FileReader();
        fr.onload= function() {
            var movimentacoes = CSVToMovimentacao(fr.result);
            var states = {};
            executarMovimentacoes(states, movimentacoes)
            updateTable(states);
        }
          
        fr.readAsText(this.files[0]);
    })
</script>
