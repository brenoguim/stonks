<!DOCTYPE html>
<html>

<style>
table, td {
  border: 1px solid black;
}
</style>

<head>
<title>Stonks</title>
<meta charset="utf-8" />
</head>

<body>
  <h1>Adicionar arquivo de movimentações</h1>

  <input type="file" name="inputfile" accept=".csv" id="inputfile" multiple/>
  
<table id="TabelaDeImpostos">
<thead>
    <tr>
    <td>Mes/Ano</td>
    <td>Total de vendas</td>
    <td>Lucro acumulado</td>
    <td>Imposto</td>
    <td>Isento</td>
    </tr>
</thead>
</table>

<table id="TabelaDeMovimentacoes">
<thead>
    <tr>
    <td>Ação</td>
    <td>Data</td>
    <td>Operação</td>
    <td>Número de ações</td>
    <td>Preço</td>
    <td>Estado da carteira</td>
    <td>Acumulado de ações</td>
    <td>Preço médio</td>
    <td>Valor patrimonial</td>
    <td>Lucro acumulado</td>
    </tr>
</thead>
</table>
  
  
</body>
</html>

<script>

let realBRLocale = Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
});

function asCurrency(value) {
    return realBRLocale.format(value)
}

class Movimentacao {
    constructor(numAcoes, preco, salario, data) {
        this.numAcoes = numAcoes;
        this.preco = preco;
        this.salario = salario
        this.data = data
    }
    
    static default() {
        return new Movimentacao(0,0,false, new Date(1900, 1, 1));
    }

    compra() {
        return this.numAcoes >= 0
    }
}

class Estado {
    constructor(numAcoes, precoMedio, lucroAcumulado, impostoAcumulado, data) {
        this.numAcoes = numAcoes
        this.precoMedio = precoMedio;
        this.lucroAcumulado = lucroAcumulado;
        this.data = data
    }
    
    static default() {
        return new Estado(0,0,0,0, new Date(1900,1,1));
    }
    
    clone() {
        return new Estado(this.numAcoes, this.precoMedio, this.lucroAcumulado, this.impostoAcumulado, this.data)
    }
    
    valor() {
        return this.numAcoes * this.precoMedio
    }
}

function aplicarMovimentacao(estado, mov) {
    var nestado = estado.clone()
    
    var valor = nestado.valor()
    
    nestado.numAcoes += mov.numAcoes
    
    if (mov.compra()) {
        nestado.precoMedio = (valor + mov.numAcoes * mov.preco) / nestado.numAcoes
    } else {
        var lucro = -1 * mov.numAcoes * (mov.preco - nestado.precoMedio);
        nestado.lucroAcumulado += lucro
    }
    
    if (nestado.numAcoes == 0)
    {
        nestado.precoMedio = 0
    }
    
    return nestado
}

function parseCurrency(value) {
    return value.replace(/,/, '.').replace(/[.](?=.*[.])/g, "")
}

function parseDate(date) {
    // Expect DD/MM/YYYY
    var parts = date.split("/")
    return new Date(parseInt(parts[2]),
                    parseInt(parts[1]),
                    parseInt(parts[0]))
}

function CSVToMovimentacao(text, movimentacoes) {
    var lines = text.split(/\r?\n|\r|\n/g);
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].length == 0) {
            continue
        }
        
        var items = lines[i].split(/;/g)
        if (!(items[0] in movimentacoes)) {
            movimentacoes[items[0]] = []
        }

        movimentacoes[items[0]].push(new Movimentacao(
            parseInt(items[2]),
            parseCurrency(items[3]),
            /*salario=*/false,
            parseDate(items[1]),
            ))
    }
}

function executarMovimentacoes(states, movimentacoes) {
    for (const [acao, movs] of Object.entries(movimentacoes)) {
        if (!(acao in states)) {
            states[acao] = [[Movimentacao.default(), Estado.default()]]
        }
        for (let i = 0; i < movs.length; i++) {
            var last = states[acao][states[acao].length - 1];
            var mov = movs[i]
            var last_state = last[1]
            var new_state = aplicarMovimentacao(last_state, mov)
            states[acao].push([mov, new_state])
        }
    }    
}

function updateTable(states) {
    var table = document.getElementById("TabelaDeMovimentacoes");
    
    while (table.rows.length > 1) {
        table.deleteRow(-1);
    }
  
    for (const [acao, mov2states] of Object.entries(states)) {
        table.insertRow(-1).insertCell(0).innerHTML = acao
        for (let i = 0; i < mov2states.length; i++) {          
            var row = table.insertRow(-1);
            var mov = mov2states[i][0];
            var state = mov2states[i][1]
            var data = [
                "",
                mov.data.toLocaleDateString(),
                mov.compra() ? "Compra" : "Venda",
                mov.numAcoes,
                asCurrency(mov.preco),
                "",
                state.numAcoes,
                asCurrency(state.precoMedio),
                asCurrency(state.valor()),
                asCurrency(state.lucroAcumulado),
            ]
            
            for (let j = 0; j < data.length; j++) {
                row.insertCell(j).innerHTML = data[j]
            }
        }

    }
}

function calculateTaxes(states)
{

    var month2movs = {};
    for (const [acao, mov2states] of Object.entries(states)) {
        for (let i = 0; i < mov2states.length; i++) {
            tmpdate = mov2states[i][0].data
            date = new Date(tmpdate.getFullYear(), tmpdate.getMonth(), 1);
            date = date.toLocaleDateString()
            if (!(date in month2movs)) {
                month2movs[date] = []
            }
            month2movs[date].push(mov2states[i])
        }
    }
    
    month2tax = {};
    for (const [month, movs] of Object.entries(month2movs)) {
        total_vendas = 0;
        lucro_acumulado = 0;
        imposto = 0;
        isento = false;
        
        for (let i = 0; i < movs.length; i++) {
            mov = movs[i][0]
            st = movs[i][1]
            
            if (!mov.compra()) {
                venda = -1 * mov.preco * mov.numAcoes
                total_vendas += venda;
                console.log(st.precoMedio)
                lucro_acumulado += venda - (-1 * st.precoMedio * mov.numAcoes);
            }
        }
        
        isento = total_vendas <= 20000;
        
        month2tax[month] = [total_vendas, lucro_acumulado, imposto, isento];
    }
    
    return month2tax;
}

function updateTaxTable(taxes) {
    var table = document.getElementById("TabelaDeImpostos");
    
    while (table.rows.length > 1) {
        table.deleteRow(-1);
    }
  
    for (const [month, tax] of Object.entries(taxes)) {
        var row = table.insertRow(-1);
        row.insertCell(-1).innerHTML = month;
        for (let j = 0; j < tax.length; j++) {
            display = tax[j]
            if (j >= 0 && j < 3) {
                display = asCurrency(display)
            }
            row.insertCell(-1).innerHTML = display
        }
    }
}

function sortByDate(acao2movs) {
    for (let [acao, movs] of Object.entries(acao2movs)) {
        movs.sort(function (mov1, mov2) {
            return mov1.data < mov2.data ? -1 : 1;
        });
    }
}

var movimentacoes = {};

function readFile(file) {
    var fr = new FileReader();
    fr.onload = function() {
        CSVToMovimentacao(fr.result, movimentacoes);
        sortByDate(movimentacoes);   
        var states = {};
        executarMovimentacoes(states, movimentacoes);
        updateTable(states);
        updateTaxTable(calculateTaxes(states));
    };
    fr.readAsText(file);
}

document.getElementById('inputfile')
    .addEventListener('change', function() {
        for (let i = 0; i < this.files.length; i++) {
            readFile(this.files[i]);
        }
    })
</script>
